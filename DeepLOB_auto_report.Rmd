---
title: "DeepLOB Market-Making — Results & Analysis"
author: "DeepLOBMarketMkr"
date: "`r format(Sys.Date())`"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
    number_sections: true
    df_print: tibble
---

```{r setup, include=FALSE}
req <- c("data.table","ggplot2","scales","zoo","yaml","dplyr","tidyr","readr","tibble","tools","stringr","knitr")
to_install <- setdiff(req, rownames(installed.packages()))
if (length(to_install)) install.packages(to_install, quiet = TRUE)

suppressPackageStartupMessages({
  library(data.table); library(ggplot2); library(scales); library(zoo); library(yaml)
  library(dplyr); library(tidyr); library(readr); library(tibble); library(tools); library(stringr); library(knitr)
})

`%||%` <- function(x, y) if (is.null(x)) y else x
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, fig.width = 9, fig.height = 4.5)
theme_set(theme_minimal(base_size = 12))

find_file <- function(filename) {
  hits <- list.files(".", pattern = paste0("^", gsub("\\.", "\\\\.", filename), "$"),
                     recursive = TRUE, full.names = TRUE)
  if (length(hits)) hits[[1]] else NA_character_
}
```

```{r}
print("✅ R chunks are executing. If you see this, knitr is running.")
```

```{r}
params_path <- if (file.exists("params.yml")) "params.yml" else find_file("params.yml")
params_list <- if (!is.na(params_path)) yaml::read_yaml(params_path) else NULL

data_paths   <- (params_list$data) %||% list(raw_path = "data/raw/", processed_path = "data/processed/")
strategy_cfg <- (params_list$strategy) %||% list()

df_snapshot <- tibble::tibble(
  item  = c("working_dir","params_path","raw_path","processed_path"),
  value = c(normalizePath(".", winslash="/"),
            params_path %||% "params.yml not found",
            data_paths$raw_path %||% "—",
            data_paths$processed_path %||% "—")
)
kable(df_snapshot, caption = "Project snapshot")
```

```{r}
path_features  <- if (file.exists("features.csv")) "features.csv" else find_file("features.csv")
path_lob_clean <- if (file.exists("lob_clean.csv")) "lob_clean.csv" else find_file("lob_clean.csv")
path_test_lob  <- if (file.exists("test_lob.csv")) "test_lob.csv" else find_file("test_lob.csv")

exists_read_csv <- function(path) if (!is.na(path) && file.exists(path)) suppressMessages(readr::read_csv(path, show_col_types = FALSE)) else NULL
features   <- exists_read_csv(path_features)
lob_clean  <- exists_read_csv(path_lob_clean)
test_lob   <- exists_read_csv(path_test_lob)

tbl_paths <- tibble::tibble(
  file = c("features.csv","lob_clean.csv","test_lob.csv"),
  path = c(path_features, path_lob_clean, path_test_lob),
  exists = c(file.exists(path_features), file.exists(path_lob_clean), file.exists(path_test_lob))
)
kable(tbl_paths, caption = "Data files discovered")

if (!is.null(features)) kable(head(features, 5), caption = "First 5 rows of features.csv")
```

```{r, fig.height=3.8}
if (!is.null(features) && "ts" %in% names(features)) {
  features |>
    mutate(ts = as.POSIXct(ts, tz = "UTC")) |>
    arrange(ts) |>
    select(any_of(c("ts","mid","spread","ret1s"))) |>
    pivot_longer(-ts, names_to = "metric", values_to = "value") |>
    ggplot(aes(ts, value)) + 
    geom_line() + 
    facet_wrap(~ metric, scales = "free_y", ncol = 1) +
    labs(title = "Core Streams from features.csv", x = NULL, y = NULL)
} else {
  print("ℹ️ Skipping features plot: features.csv missing or lacks 'ts'.")
}
```

```{r}
p_baseline <- if (file.exists("baseline_trades.csv")) "baseline_trades.csv" else find_file("baseline_trades.csv")
p_glm      <- if (file.exists("glm_trades.csv")) "glm_trades.csv" else find_file("glm_trades.csv")
p_rf       <- if (file.exists("rf_trades.csv"))  "rf_trades.csv"  else find_file("rf_trades.csv")
p_rl       <- if (file.exists("rl_trades.csv"))  "rl_trades.csv"  else find_file("rl_trades.csv")

read_if <- function(path) if (!is.na(path) && file.exists(path)) readr::read_csv(path, show_col_types = FALSE) else NULL
baseline <- read_if(p_baseline)
glm      <- read_if(p_glm)
rf       <- read_if(p_rf)
rl       <- read_if(p_rl)

norm_trades <- function(df, name){
  if (is.null(df)) return(NULL)
  dt <- as_tibble(df)
  if ("ts" %in% names(dt)) dt$ts <- as.POSIXct(dt$ts, tz = "UTC")

  preferred <- c("PnL_net","PnL","pnl","PnL_RL",
                 "PnL_glm","PnL_rf","PnL_baseline","PnL_rl",
                 "ret","ret_glm","ret_rf","ret_baseline","ret_rl")
  pnl_col <- intersect(preferred, names(dt))
  if (length(pnl_col) > 1) pnl_col <- pnl_col[1]
  if (!length(pnl_col)) {
    hits <- grep("^(PnL|pnl|ret)", names(dt), value = TRUE)
    if (length(hits) > 1) hits <- hits[1]
    pnl_col <- if (length(hits)) hits else NA_character_
  }
  if (is.na(pnl_col)) return(NULL)

  dt |>
    transmute(
      ts   = if ("ts" %in% names(dt)) ts else row_number(),
      pnl  = .data[[pnl_col]],
      strat = name
    )
}

trades_list <- list(
  Baseline = norm_trades(baseline, "Baseline"),
  GLM      = norm_trades(glm,      "GLM"),
  RF       = norm_trades(rf,       "RF"),
  RL       = norm_trades(rl,       "RL")
)
trades <- bind_rows(Filter(Negate(is.null), trades_list))

tbl_trade_paths <- tibble::tibble(
  strategy = c("Baseline","GLM","RF","RL"),
  path = c(p_baseline, p_glm, p_rf, p_rl),
  loaded = c(!is.null(trades_list$Baseline),
             !is.null(trades_list$GLM),
             !is.null(trades_list$RF),
             !is.null(trades_list$RL))
)
kable(tbl_trade_paths, caption = "Trade files discovered & loaded")
if (nrow(trades) == 0) print("⚠️ No trade files loaded or no PnL/ret column detected.")
```

```{r, fig.height=4}
if (nrow(trades) > 0) {
  perf <- trades |>
    arrange(ts) |>
    group_by(strat) |>
    mutate(
      pnl_cum = cumsum(replace_na(pnl, 0)),
      ret     = pnl,
      ret_cum = cumsum(replace_na(ret, 0))
    ) |>
    ungroup()
  ggplot(perf, aes(ts, pnl_cum, group = strat, color = strat)) +
    geom_line() +
    labs(title = "Cumulative PnL by Strategy", x = NULL, y = "Cumulative PnL")
} else {
  print("ℹ️ Skipping PnL plot: no trades.")
}
```

```{r}
if (exists("perf") && nrow(perf) > 0) {
  perf_tbl <- perf |>
    group_by(strat) |>
    summarise(
      n_trades = dplyr::n(),
      pnl_total = sum(pnl, na.rm = TRUE),
      pnl_mean  = mean(pnl, na.rm = TRUE),
      pnl_sd    = sd(pnl, na.rm = TRUE),
      sharpe    = ifelse(pnl_sd > 0, pnl_mean / pnl_sd * sqrt(252), NA_real_),
      hit_rate  = mean(pnl > 0, na.rm = TRUE)
    ) |>
    arrange(desc(pnl_total))
  kable(perf_tbl, caption = "Performance summary")
} else {
  print("ℹ️ Performance table skipped: no perf data yet.")
}
```

```{r, fig.height=4}
if (exists("perf") && nrow(perf) > 0) {
  dd <- perf |>
    group_by(strat) |>
    arrange(ts) |>
    mutate(peak = cummax(pnl_cum), drawdown = pnl_cum - peak)
  ggplot(dd, aes(ts, drawdown, group = strat, color = strat)) +
    geom_line() +
    labs(title = "Drawdown by Strategy", x = NULL, y = "Drawdown")
} else {
  print("ℹ️ Drawdown plot skipped: no perf data yet.")
}
```

```{r}
rl_cfg <- (strategy_cfg$rl) %||% list(gamma = 0.99, learning_rate = 5e-4, epsilon_start = 0.9, epsilon_end = 0.01, epsilon_decay = 50000)
kable(tibble::enframe(rl_cfg, name="param", value="value"), caption = "RL config")
```

```{r}
appendix <- tibble::tibble(
  file = c("baseline_trades.csv","glm_trades.csv","rf_trades.csv","rl_trades.csv"),
  loaded = c(!is.null(trades_list$Baseline), !is.null(trades_list$GLM), !is.null(trades_list$RF), !is.null(trades_list$RL)),
  columns = c(paste(if (!is.null(baseline)) names(baseline) else "—", collapse=", "),
              paste(if (!is.null(glm))      names(glm)      else "—", collapse=", "),
              paste(if (!is.null(rf))       names(rf)       else "—", collapse=", "),
              paste(if (!is.null(rl))       names(rl)       else "—", collapse=", "))
)
kable(appendix, caption = "Columns detected in each trade file")
```
```{r figdir, include=FALSE}
fig_dir <- "figures"
if (!dir.exists(fig_dir)) dir.create(fig_dir, recursive = TRUE)
### 2) Replace your **Cumulative PnL** chunk with this (adds `ggsave`)
```r
```{r, fig.height=4}
if (nrow(trades) > 0) {
  perf <- trades |>
    arrange(ts) |>
    group_by(strat) |>
    mutate(
      pnl_cum = cumsum(replace_na(pnl, 0)),
      ret     = pnl,
      ret_cum = cumsum(replace_na(ret, 0))
    ) |>
    ungroup()
  p_pnl <- ggplot(perf, aes(ts, pnl_cum, group = strat, color = strat)) +
    geom_line() +
    labs(title = "Cumulative PnL by Strategy", x = NULL, y = "Cumulative PnL")
  print(p_pnl)

  # save PNG for README
  ggsave(file.path(fig_dir, "pnl_by_strategy.png"), p_pnl, width = 9, height = 4.5, dpi = 150)
} else {
  print("ℹ️ Skipping PnL plot: no trades.")
}
### 3) Replace your **Drawdowns** chunk with this
```r
```{r, fig.height=4}
if (exists("perf") && nrow(perf) > 0) {
  dd <- perf |>
    group_by(strat) |>
    arrange(ts) |>
    mutate(peak = cummax(pnl_cum), drawdown = pnl_cum - peak)
  p_dd <- ggplot(dd, aes(ts, drawdown, group = strat, color = strat)) +
    geom_line() +
    labs(title = "Drawdown by Strategy", x = NULL, y = "Drawdown")
  print(p_dd)

  # save PNG for README
  ggsave(file.path(fig_dir, "drawdown_by_strategy.png"), p_dd, width = 9, height = 4.5, dpi = 150)
} else {
  print("ℹ️ Drawdown plot skipped: no perf data yet.")
}
### 4) (Optional) Save the **features overview** plot too
Find your features plot chunk and wrap it like this:
```r
```{r, fig.height=3.8}
if (!is.null(features) && "ts" %in% names(features)) {
  p_feat <- features |>
    mutate(ts = as.POSIXct(ts, tz = "UTC")) |>
    arrange(ts) |>
    select(any_of(c("ts","mid","spread","ret1s"))) |>
    pivot_longer(-ts, names_to = "metric", values_to = "value") |>
    ggplot(aes(ts, value)) + 
    geom_line() + 
    facet_wrap(~ metric, scales = "free_y", ncol = 1) +
    labs(title = "Core Streams from features.csv", x = NULL, y = NULL)
  print(p_feat)

  ggsave(file.path(fig_dir, "features_core.png"), p_feat, width = 9, height = 5, dpi = 150)
} else {
  print("ℹ️ Skipping features plot: features.csv missing or lacks 'ts'.")
}
### 5) (Optional) Save the **performance table** to CSV
In your Performance Table chunk (where you build `perf_tbl`), append:
```r
  # also export summary for reference
  readr::write_csv(perf_tbl, "output/results/perf_summary.csv")

